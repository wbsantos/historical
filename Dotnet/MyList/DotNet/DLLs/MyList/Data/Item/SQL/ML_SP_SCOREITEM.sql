IF EXISTS (SELECT * FROM SYSOBJECTS WHERE TYPE = 'P' AND NAME = 'ML_SP_SCOREITEM')
	BEGIN
		PRINT 'DROPPING PROCEDURE ML_SP_SCOREITEM'
		DROP  PROCEDURE ML_SP_SCOREITEM
	END
GO

PRINT 'CREATING PROCEDURE ML_SP_SCOREITEM'
GO

CREATE PROCEDURE ML_SP_SCOREITEM
	@IDITEM INT,
	@IDUSU INT,
	@SCORE FLOAT,
	@NEWITEMSCORE FLOAT OUT
AS

/******************************************************************************
**		NOME DO AQUIVO: ML_SP_SCOREITEM.SQL
**		NOME DA PROCEDURE: ML_SP_SCOREITEM
**
**		DESCRIÇÃO: PROCEDURE RESPONSÁVEL EM SETAR UM SCORE PARA UM ITEM.
**      
**
**		TEAMPLATE ELABORADO POR: WILLIAM BARBOSA
**              
**		PROGRAMADOR AUTOR: WILLIAM BARBOSA
**		DATA: 10/04/2016
*******************************************************************************
**		HISTÓRICO DE ALTERAÇÕES
*******************************************************************************
**		DATA:		AUTOR:				DESCRIÇÃO:
**
*******************************************************************************/

DECLARE @CURRENTSCORE FLOAT

SELECT 
	@CURRENTSCORE = ISSCORE 
FROM 
	ITEM_SCORES WITH(NOLOCK) 
WHERE 
	ISUSID = @IDUSU

IF(@CURRENTSCORE IS NULL)
BEGIN
	INSERT INTO ITEM_SCORES (ISITID, ISUSID, ISSCORE)
					 VALUES(@IDITEM, @IDUSU, @SCORE)

	UPDATE ITEM
	SET
		ITSCORE = (ITTOTALSCORE + @SCORE) / (ITSCORERS + 1.0),
		ITSCORERS = ITSCORERS + 1,
		ITTOTALSCORE = ITTOTALSCORE + @SCORE
	WHERE
		ITID = @IDITEM
END
ELSE
BEGIN
	UPDATE ITEM_SCORES
	SET
		ISSCORE = @SCORE
	WHERE
		ISUSID = @IDUSU AND
		ISITID = @IDITEM

	UPDATE ITEM
	SET
		ITSCORE = (ITTOTALSCORE - @CURRENTSCORE + @SCORE) / ITSCORERS,
		ITTOTALSCORE = ITTOTALSCORE - @CURRENTSCORE + @SCORE
	WHERE
		ITID = @IDITEM
END

SELECT 
	@NEWITEMSCORE = ITSCORE 
FROM 
	ITEM WITH(NOLOCK) 
WHERE 
	ITID = @IDITEM

RETURN 0