IF EXISTS (SELECT * FROM SYSOBJECTS WHERE TYPE = 'P' AND NAME = 'ML_SP_GETITENS')
	BEGIN
		PRINT 'DROPPING PROCEDURE ML_SP_GETITENS'
		DROP  PROCEDURE ML_SP_GETITENS
	END
GO

PRINT 'CREATING PROCEDURE ML_SP_GETITENS'
GO

CREATE PROCEDURE ML_SP_GETITENS
	@CATEGORIAID INT,
	@GENEROS VARCHAR(4000),
	@STARTROW INT,
	@TOTALROWS INT
AS

/******************************************************************************
**		NOME DO AQUIVO: ML_SP_GETITENS.SQL
**		NOME DA PROCEDURE: ML_SP_GETITENS
**
**		DESCRIÇÃO: PROCEDURE RESPONSÁVEL EM CONSULTAR ITENS CADASTRADOS FILTRANDO POR CATEGORIA.
**      
**
**		TEAMPLATE ELABORADO POR: WILLIAM BARBOSA
**              
**		PROGRAMADOR AUTOR: WILLIAM BARBOSA
**		DATA: 08/11/2015
*******************************************************************************
**		HISTÓRICO DE ALTERAÇÕES
*******************************************************************************
**		DATA:		AUTOR:				DESCRIÇÃO:
**
*******************************************************************************/

DECLARE @IDGENEROS TABLE(VALUE INT)
INSERT INTO @IDGENEROS 
SELECT VALUE FROM FN_SPLITTOTABLE(@GENEROS, ',')

SELECT	
	ITID, 
	ITTITULO, 
	ITSINOPSE, 
	ITSCORE, 
	SGID, 
	SGTITULO, 
	CTID
FROM ITEM					WITH(NOLOCK)
INNER JOIN ITEM_CATEGORIA	WITH(NOLOCK) ON ICITID = ITID
INNER JOIN CATEGORIA		WITH(NOLOCK) ON CTID = ICCTID
LEFT  JOIN ITEM_SAGA		WITH(NOLOCK) ON ISITID = ITID
LEFT  JOIN SAGA				WITH(NOLOCK) ON SGID = ISSGID
WHERE 
	@CATEGORIAID IN (CTID, CTPAI)  AND 
	(@GENEROS IS NULL OR EXISTS(SELECT 
									VALUE 
								FROM @IDGENEROS
								INNER JOIN ITEM_GENERO WITH(NOLOCK) ON 
									IGITID = ITID AND 
									IGGRID = VALUE))
ORDER BY ITID
OFFSET @STARTROW ROWS FETCH NEXT @TOTALROWS ROWS ONLY

RETURN 0