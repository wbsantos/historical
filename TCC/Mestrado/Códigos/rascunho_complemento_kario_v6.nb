(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     29480,        665]
NotebookOptionsPosition[     28992,        646]
NotebookOutlinePosition[     29338,        661]
CellTagsIndexPosition[     29295,        658]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{"<<", "CATemplates`"}]], "Input",
 CellChangeTimes->{{3.7215507395650854`*^9, 3.721550740190138*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"ChangeSymbols", "[", "core_List", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"newCore", "=", "core"}], ",", 
      RowBox[{"coreSymbols", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"Select", "[", 
             RowBox[{
              RowBox[{"Position", "[", 
               RowBox[{"core", ",", "#"}], "]"}], ",", 
              RowBox[{
               RowBox[{
                RowBox[{"Length", "[", "#", "]"}], "\[Equal]", "1"}], "&"}]}],
              "]"}], "[", 
            RowBox[{"[", "1", "]"}], "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], "&"}], ",", 
         RowBox[{"DeleteDuplicates", "[", 
          RowBox[{"Select", "[", 
           RowBox[{"core", ",", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"Length", "[", "#", "]"}], "\[Equal]", "0"}], "&&", 
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", "0", "]"}], "]"}], "===", "Symbol"}]}], "&"}]}], 
           "]"}], "]"}]}], "]"}]}]}], "}"}], ",", 
    RowBox[{
     RowBox[{"For", "[", 
      RowBox[{
       RowBox[{"i", "=", "1"}], ",", 
       RowBox[{"i", "\[LessEqual]", 
        RowBox[{"Length", "[", "coreSymbols", "]"}]}], ",", 
       RowBox[{"i", "++"}], ",", 
       RowBox[{"newCore", "=", 
        RowBox[{"(", 
         RowBox[{"newCore", "/.", 
          RowBox[{
           RowBox[{"core", "[", 
            RowBox[{"[", 
             RowBox[{"coreSymbols", "[", 
              RowBox[{"[", "i", "]"}], "]"}], "]"}], "]"}], "\[Rule]", 
           RowBox[{"Symbol", "[", 
            RowBox[{"\"\<x\>\"", "<>", 
             RowBox[{"ToString", "[", 
              RowBox[{
               RowBox[{"Length", "[", "core", "]"}], "-", 
               RowBox[{"coreSymbols", "[", 
                RowBox[{"[", "i", "]"}], "]"}]}], "]"}]}], "]"}]}]}], 
         ")"}]}]}], "]"}], ";", "\[IndentingNewLine]", "newCore"}]}], 
   "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Problema", ":", 
     RowBox[{
     "Nome", " ", "das", " ", "vari\[AAcute]veis", " ", "s\[ATilde]o", " ", 
      "muito", " ", "importantes", " ", "para", " ", "correto", " ", 
      "funcionando"}]}], ",", 
    RowBox[{
    "mas", " ", "essa", " ", "depend\[EHat]ncia", " ", "n\[ATilde]o", " ", 
     "deveria", " ", "existis"}]}], "*)"}], 
  RowBox[{
   RowBox[{"ComplementaryTemplate", "[", "template1_Association", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"baseTemplate", "=", 
       RowBox[{"BaseTemplateCore", "[", 
        RowBox[{
         RowBox[{"k", "[", "template1", "]"}], ",", 
         RowBox[{"r", "[", "template1", "]"}]}], "]"}]}], "}"}], ",", " ", 
     RowBox[{
      RowBox[{"complementEquation", "=", 
       RowBox[{"(", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"#", "&"}], "/@", 
          RowBox[{"Map", "[", 
           RowBox[{"(*", 
            RowBox[{
            "Iguala", " ", "cada", " ", "campo", " ", "calculado", " ", "ao", 
             " ", "MOD", " ", "respectivo", " ", "para", " ", "realizar", " ",
              "a", " ", "nega\[CCedilla]\[ATilde]o", " ", "do", " ", "valor", 
             " ", "da", " ", "equa\[CCedilla]\[ATilde]o"}], "*)"}], 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"Part", "[", 
               RowBox[{"#", ",", "1"}], "]"}], "\[Equal]", " ", 
              RowBox[{"Mod", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"Part", "[", 
                  RowBox[{"#", ",", "2"}], "]"}], "+", "w"}], ",", 
                RowBox[{"k", "[", "template1", "]"}]}], "]"}]}], "&"}], ",", 
            RowBox[{"Select", "[", 
             RowBox[{"(*", 
              RowBox[{
               RowBox[{
               "Filtra", " ", "somente", " ", "as", " ", 
                "posi\[CCedilla]\[OTilde]es", " ", "calculadas", " ", "do", 
                " ", "template"}], ",", 
               RowBox[{
               "ignorando", " ", "vari\[AAcute]veis", " ", "livres"}]}], 
              "*)"}], 
             RowBox[{
              RowBox[{"MapThread", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"If", "[", 
                  RowBox[{
                   RowBox[{"#1", "===", "#2"}], ",", "\"\<X\>\"", ",", 
                   RowBox[{"#1", "\[Equal]", "#2"}]}], "]"}], "&"}], ",", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"ChangeSymbols", "[", 
                   RowBox[{"BaseTemplateCore", "[", 
                    RowBox[{
                    RowBox[{"k", "[", "template1", "]"}], ",", 
                    RowBox[{"r", "[", "template1", "]"}]}], "]"}], "]"}], ",", 
                  RowBox[{"ChangeSymbols", "[", 
                   RowBox[{"templateCore", "[", "template1", "]"}], "]"}]}], 
                 "}"}]}], "]"}], ",", 
              RowBox[{
               RowBox[{"Not", "[", 
                RowBox[{"#", "===", "\"\<X\>\""}], "]"}], "&"}]}], "]"}]}], 
           "]"}]}], ")"}], " ", ")"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"listaComplemento", " ", "=", " ", 
       RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"ModTemplateQ", "[", "template1", "]"}], ",", 
        RowBox[{"{", "}"}], ",", 
        RowBox[{"AppendTo", "[", 
         RowBox[{"listaComplemento", ",", " ", 
          RowBox[{"Map", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", "1", "]"}], "]"}], " ", "\[Equal]", " ", 
               RowBox[{
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], " ", "+", " ", "1.1"}], 
                  ")"}], " ", "*", " ", 
                 RowBox[{"(", 
                  RowBox[{"1", " ", "-", " ", 
                   RowBox[{"Floor", "[", 
                    RowBox[{
                    RowBox[{"Abs", "[", 
                    RowBox[{
                    RowBox[{"1", "/", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], "]"}], " ", "\[Equal]", 
                    " ", "2"}], ",", 
                    RowBox[{
                    RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], "[", 
                    RowBox[{"[", "1", "]"}], "]"}], ",", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}]}], "]"}], " ", "-", " ", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}]}], ")"}], "+", "0.1"}], 
                    ")"}]}], "/", "10"}], "]"}], "+", "0.000000000001"}], 
                    "]"}]}], ")"}]}], "-", "1.1"}]}], "  ", "/.", " ", 
              RowBox[{"w", " ", "\[Rule]", " ", "0"}]}], " ", "&"}], " ", ",",
             " ", "complementEquation"}], "]"}]}], "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"AppendTo", "[", 
       RowBox[{"listaComplemento", ",", " ", "complementEquation"}], "]"}], 
      ";", "\[IndentingNewLine]", "listaComplemento"}]}], " ", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{"XMODK", "+", "1"}], ")"}], "*", 
       RowBox[{"(", 
        RowBox[{"1", "-", 
         RowBox[{"FLOOR", 
          RowBox[{"(", 
           RowBox[{"ABS", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"1", "/", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"X", "-", "XMODK"}], ")"}], "+", "0.1"}], ")"}]}], 
              "/", "10"}], ")"}]}], ")"}]}]}], ")"}]}], "-", "1"}], "*)"}], 
    "\[IndentingNewLine]", "]"}]}]}]], "Input",
 CellChangeTimes->{{3.7213119391967325`*^9, 3.7213119490152736`*^9}, 
   3.721315368814711*^9, {3.72131635172103*^9, 3.7213163754431705`*^9}, {
   3.721316442647564*^9, 3.7213165188606234`*^9}, {3.7213166022121687`*^9, 
   3.721316605003888*^9}, {3.7213166421627436`*^9, 3.721316692567815*^9}, {
   3.7213168375453367`*^9, 3.7213168384115353`*^9}, {3.721317141398978*^9, 
   3.72131717262553*^9}, {3.721317295855425*^9, 3.7213173489581857`*^9}, {
   3.721317440134726*^9, 3.721317489124405*^9}, {3.721317521238695*^9, 
   3.721317521727817*^9}, {3.7213175646389484`*^9, 3.721317565160084*^9}, {
   3.721317605059384*^9, 3.721317609546545*^9}, {3.721317641855908*^9, 
   3.721317725976706*^9}, {3.7213178675193386`*^9, 3.72131787069316*^9}, {
   3.7213179760094423`*^9, 3.721318051934579*^9}, {3.7213180979174805`*^9, 
   3.721318216004017*^9}, {3.7213182593742676`*^9, 3.7213183462302866`*^9}, {
   3.7213183917600803`*^9, 3.721318401416569*^9}, 3.7213184518556085`*^9, {
   3.721318507827112*^9, 3.721318509494525*^9}, {3.7213190483623037`*^9, 
   3.721319101121932*^9}, {3.721319150754806*^9, 3.721319222595502*^9}, {
   3.7213195561994905`*^9, 3.7213197899789944`*^9}, {3.7213198652264967`*^9, 
   3.7213198987401447`*^9}, {3.7213199347724943`*^9, 3.721319981086483*^9}, {
   3.7213207486355677`*^9, 3.7213207552582808`*^9}, {3.721320788105912*^9, 
   3.721320799448848*^9}, {3.721320852136484*^9, 3.721320853735899*^9}, {
   3.7213213425258017`*^9, 3.721321432604127*^9}, {3.721321524599275*^9, 
   3.721321527927408*^9}, {3.7213216050919495`*^9, 3.721321693558357*^9}, {
   3.7213217587806363`*^9, 3.7213218215381737`*^9}, {3.72132186764772*^9, 
   3.721321939598983*^9}, {3.7213413240642242`*^9, 3.7213413571907434`*^9}, {
   3.721342400431984*^9, 3.7213424061324854`*^9}, 3.7213461594355516`*^9, {
   3.721346322985114*^9, 3.7213463687858973`*^9}, {3.721346446442734*^9, 
   3.7213464612650046`*^9}, {3.7214269441444016`*^9, 3.721427059710376*^9}, {
   3.7214604488629746`*^9, 3.721460499384799*^9}, {3.721460554398514*^9, 
   3.7214606733691053`*^9}, 3.721460706574222*^9, {3.721460752846182*^9, 
   3.7214607612657146`*^9}, {3.7214608149125547`*^9, 3.721460816074007*^9}, {
   3.7214608950620437`*^9, 3.721460901806274*^9}, {3.7214611870097446`*^9, 
   3.721461197306642*^9}, {3.721507175495773*^9, 3.7215071794293833`*^9}, {
   3.7215072383943634`*^9, 3.721507355434341*^9}, 3.72150738627874*^9, {
   3.721508242561609*^9, 3.7215082567851663`*^9}, {3.7218312516470437`*^9, 
   3.721831271784102*^9}, {3.7221978214417934`*^9, 3.7221978268992944`*^9}, {
   3.7222004487620797`*^9, 3.722200510900426*^9}, {3.722200865614224*^9, 
   3.722200868646658*^9}, {3.7237299852166824`*^9, 3.723729990650942*^9}, {
   3.7237343839563894`*^9, 3.7237343890270205`*^9}, {3.7237344408907146`*^9, 
   3.723734463568135*^9}, {3.7237345045387526`*^9, 3.7237345638385754`*^9}, 
   3.7237346309928007`*^9, {3.723734759809287*^9, 3.7237347654659157`*^9}, {
   3.7237375620254507`*^9, 3.7237376118154335`*^9}, {3.7237376956172304`*^9, 
   3.723737739244584*^9}, {3.7237455646319904`*^9, 3.7237455679498734`*^9}, {
   3.7237463951533837`*^9, 3.7237463956005*^9}, {3.723746790203833*^9, 
   3.7237468029091167`*^9}, {3.7274500708786936`*^9, 3.727450109543046*^9}, {
   3.7274503741247005`*^9, 3.7274504409432383`*^9}, {3.727451906759127*^9, 
   3.7274519123891115`*^9}, {3.727455710724651*^9, 3.727455728468676*^9}, {
   3.7274557601759896`*^9, 3.727455764873357*^9}, {3.7276814243650136`*^9, 
   3.727681432299446*^9}, {3.727681544971077*^9, 3.727681545127327*^9}}],

Cell[BoxData[
 RowBox[{" ", 
  RowBox[{
   RowBox[{"OperacaoDiferenca", "[", 
    RowBox[{"template1_Association", ",", "template2_Association"}], "]"}], 
   " ", ":=", " ", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", " ", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"templateNegado", " ", "=", " ", 
       RowBox[{"OperacaoNegacao", "[", "template2", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"templateIntersected", " ", "=", 
       RowBox[{"Select", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"TemplateIntersection", "[", 
            RowBox[{"template1", ",", "#", ",", " ", "True"}], "]"}], " ", 
           "&"}], " ", "/@", " ", "templateNegado"}], ",", " ", 
         RowBox[{
          RowBox[{
           RowBox[{"templateCore", "[", "#", "]"}], " ", "=!=", " ", 
           RowBox[{"{", "}"}]}], " ", "&"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"BuildTemplate", "[", 
         RowBox[{
          RowBox[{"k", "[", "#", "]"}], ",", 
          RowBox[{"r", "[", "#", "]"}], ",", " ", 
          RowBox[{"templateCore", "[", "#", "]"}], ",", 
          RowBox[{"Select", "[", 
           RowBox[{
            RowBox[{"DeleteDuplicates", "[", " ", 
             RowBox[{"Flatten", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"postExpansionFn", "[", "template1", "]"}], ",", 
                "FilterReal"}], "}"}], "]"}], "]"}], ",", " ", 
            RowBox[{
             RowBox[{"#", " ", "=!=", " ", "IdentityFn"}], " ", "&"}]}], 
           "]"}]}], "]"}], " ", "&"}], " ", "/@", " ", 
       RowBox[{"Select", "[", 
        RowBox[{
         RowBox[{"Flatten", "[", "templateIntersected", "]"}], ",", " ", 
         RowBox[{
          RowBox[{
           RowBox[{"templateCore", "[", "#", "]"}], " ", "=!=", " ", 
           RowBox[{"{", "}"}]}], " ", "&"}]}], "]"}]}]}]}], 
    "\[IndentingNewLine]", " ", "]"}]}]}]], "Input",
 CellChangeTimes->{{3.7213119521410832`*^9, 3.7213119938172026`*^9}, {
   3.7213122216011415`*^9, 3.721312232926076*^9}, {3.7213122639891276`*^9, 
   3.7213123988990326`*^9}, {3.72131248719991*^9, 3.721312512758512*^9}, {
   3.7213125451480536`*^9, 3.7213125609132757`*^9}, {3.721312591150812*^9, 
   3.7213126548330717`*^9}, {3.721312970879241*^9, 3.7213130648785405`*^9}, {
   3.7213131063512897`*^9, 3.7213131694686213`*^9}, {3.721313225815222*^9, 
   3.721313266253688*^9}, {3.7213133128667383`*^9, 3.721313383414012*^9}, {
   3.721313513784728*^9, 3.721313624247341*^9}, {3.721313764184534*^9, 
   3.7213138743954067`*^9}, {3.721314075610896*^9, 3.721314206837831*^9}, {
   3.7213142369641485`*^9, 3.721314241136036*^9}, {3.721314396246498*^9, 
   3.7213145262025986`*^9}, {3.7213145839978504`*^9, 3.721314859048499*^9}, {
   3.721314939376568*^9, 3.7213149818395433`*^9}, 3.7213150244585876`*^9, {
   3.721315081378319*^9, 3.7213151340839596`*^9}, {3.7213151824944897`*^9, 
   3.7213152813810816`*^9}, {3.7213161698899713`*^9, 3.721316236314162*^9}, {
   3.7213168859358363`*^9, 3.7213168865550213`*^9}, 3.7213188353268776`*^9, {
   3.721318866275879*^9, 3.7213188808826575`*^9}, {3.7213192685690656`*^9, 
   3.721319296783377*^9}, {3.7213193634076195`*^9, 3.721319452148559*^9}, 
   3.721319537944765*^9, {3.7213220167123795`*^9, 3.7213220483938336`*^9}, {
   3.7213220985621223`*^9, 3.7213221712416506`*^9}, {3.721322244817705*^9, 
   3.7213222454583535`*^9}, {3.7213224011274004`*^9, 
   3.7213224779976263`*^9}, {3.7213225203779593`*^9, 3.721322553109516*^9}, {
   3.7213393962453184`*^9, 3.7213394040063267`*^9}, {3.721339461590233*^9, 
   3.721339510117764*^9}, {3.7213395943265843`*^9, 3.721339594969751*^9}, {
   3.721339675018496*^9, 3.7213397055233765`*^9}, {3.721339747112155*^9, 
   3.7213397861932697`*^9}, {3.721339821699444*^9, 3.7213398494336157`*^9}, {
   3.7213399235229163`*^9, 3.7213400184724855`*^9}, {3.7213402364539075`*^9, 
   3.721340252081952*^9}, 3.7213404581702857`*^9, {3.721340539686388*^9, 
   3.7213405402785425`*^9}, {3.7213405939534063`*^9, 3.7213406693207073`*^9}, 
   3.7213407490958586`*^9, {3.721340942558793*^9, 3.7213410142452097`*^9}, {
   3.72134112284529*^9, 3.721341128876816*^9}, {3.721341208755462*^9, 
   3.7213412295520935`*^9}, {3.721341656635338*^9, 3.721341657238948*^9}, {
   3.7213451890129395`*^9, 3.7213452163150067`*^9}, {3.721345482646339*^9, 
   3.7213454870405025`*^9}, {3.721345528561221*^9, 3.72134553610419*^9}, {
   3.72134558258738*^9, 3.721345643134959*^9}, {3.72134583747534*^9, 
   3.7213458863376026`*^9}, {3.7213465366423945`*^9, 
   3.7213465432837853`*^9}, {3.721420794552812*^9, 3.7214208222770014`*^9}, {
   3.721420855216527*^9, 3.72142087388033*^9}, {3.7214209040610123`*^9, 
   3.721420910614278*^9}, 3.7214209482187557`*^9, {3.721421093744446*^9, 
   3.721421183835748*^9}, {3.721421219513997*^9, 3.721421222255684*^9}, {
   3.7214212885998507`*^9, 3.7214213404782777`*^9}, {3.7214213767506914`*^9, 
   3.7214213975910854`*^9}, 3.7214220652419643`*^9, {3.721423573470001*^9, 
   3.721423593980487*^9}, 3.721423648579617*^9, 3.721424070232253*^9, {
   3.7214270802767177`*^9, 3.721427094530414*^9}, 3.721427213914116*^9, {
   3.721427471842347*^9, 3.721427487115961*^9}, 3.721507918183943*^9, 
   3.721508866344548*^9, 3.7215090354061437`*^9, 3.7215116831308827`*^9, {
   3.721829659289131*^9, 3.7218296838047953`*^9}, {3.7218309597570086`*^9, 
   3.7218309618414774`*^9}, {3.721831143143895*^9, 3.721831143776121*^9}, {
   3.721831201444524*^9, 3.7218312121796465`*^9}, {3.721831255352137*^9, 
   3.7218312749054384`*^9}, {3.721833364055384*^9, 3.721833366063077*^9}, {
   3.7218334084463205`*^9, 3.7218334110032873`*^9}, 3.7218365626605034`*^9, {
   3.7219200803319125`*^9, 3.7219201475513415`*^9}, {3.721922269354061*^9, 
   3.7219222735941973`*^9}, {3.721922320819614*^9, 3.7219223254314713`*^9}, {
   3.7219223730519886`*^9, 3.721922377818679*^9}, {3.7221188783110747`*^9, 
   3.7221188969157095`*^9}, {3.7221189800992174`*^9, 
   3.7221189853184347`*^9}, {3.7221191151379128`*^9, 3.722119148545672*^9}, {
   3.723747293732947*^9, 3.7237473401010246`*^9}, {3.7237474294582605`*^9, 
   3.723747429962392*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"OperacaoNegacao", "[", "template1_Association", "]"}], " ", ":=", 
  " ", 
  RowBox[{"With", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"complementaryTemplate", " ", "=", " ", 
      RowBox[{"ComplementaryTemplate", "[", "template1", "]"}]}], " ", "}"}], 
    ",", 
    RowBox[{
     RowBox[{"totalItems", " ", "=", " ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Length", "[", "complementaryTemplate", "]"}], " ", ">", 
          " ", "0"}], " ", "&&", " ", 
         RowBox[{
          RowBox[{"Length", "[", 
           RowBox[{"complementaryTemplate", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "]"}], " ", ">", " ", "0"}]}], 
        ",", "  ", 
        RowBox[{"Length", "[", 
         RowBox[{"complementaryTemplate", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "]"}], ",", " ", "0"}], "]"}]}], 
     ";", 
     RowBox[{"lista", " ", "=", " ", 
      RowBox[{"{", "}"}]}], ";", " ", 
     RowBox[{"templates", " ", "=", 
      RowBox[{"{", "}"}]}], ";", " ", 
     RowBox[{"For", "[", 
      RowBox[{
       RowBox[{"u", "=", "1"}], ",", 
       RowBox[{"u", "\[LessEqual]", "totalItems"}], ",", 
       RowBox[{"u", "++"}], ",", " ", 
       RowBox[{"AppendTo", "[", " ", 
        RowBox[{"lista", ",", 
         RowBox[{
          RowBox[{
           RowBox[{"#", "[", 
            RowBox[{"[", "u", "]"}], "]"}], " ", "&"}], " ", "/@", "  ", 
          "complementaryTemplate"}]}], "]"}]}], "]"}], ";", " ", 
     RowBox[{"For", "[", 
      RowBox[{
       RowBox[{"v", "=", "1"}], ",", 
       RowBox[{"v", "\[LessEqual]", 
        RowBox[{"Length", "[", "lista", "]"}]}], ",", 
       RowBox[{"v", "++"}], ",", " ", 
       RowBox[{"AppendTo", "[", " ", 
        RowBox[{"templates", ",", " ", 
         RowBox[{"BuildTemplate", "[", 
          RowBox[{
           RowBox[{"k", "[", "template1", "]"}], ",", 
           RowBox[{"r", "[", "template1", "]"}], ",", " ", 
           RowBox[{"Map", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"#", " ", "===", " ", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"lista", "[", 
                    RowBox[{"[", "v", "]"}], "]"}], "[", 
                   RowBox[{"[", "1", "]"}], "]"}], "[", 
                  RowBox[{"[", "1", "]"}], "]"}]}], ",", " ", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], " ", "&"}], " ", "/@", 
                  " ", 
                  RowBox[{"lista", "[", 
                   RowBox[{"[", "v", "]"}], "]"}]}], ")"}], " ", ",", "#"}], 
               "]"}], " ", "&"}], ",", 
             RowBox[{"BaseTemplateCore", "[", 
              RowBox[{
               RowBox[{"k", "[", "template1", "]"}], ",", 
               RowBox[{"r", "[", "template1", "]"}]}], "]"}]}], "]"}]}], 
          "]"}]}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"coreList", " ", "=", " ", 
      RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"templateBase", " ", "=", " ", 
      RowBox[{"BuildTemplate", "[", 
       RowBox[{
        RowBox[{"k", "[", "template1", "]"}], ",", 
        RowBox[{"r", "[", "template1", "]"}], ",", " ", 
        RowBox[{"BaseTemplateCore", "[", 
         RowBox[{
          RowBox[{"k", "[", "template1", "]"}], ",", 
          RowBox[{"r", "[", "template1", "]"}]}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"For", "[", 
      RowBox[{
       RowBox[{"h", " ", "=", " ", "1"}], ",", 
       RowBox[{"h", "\[LessEqual]", " ", 
        RowBox[{"Length", "[", 
         RowBox[{"lista", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ",", 
       RowBox[{"h", "++"}], ",", "\[IndentingNewLine]", 
       RowBox[{"For", "[", 
        RowBox[{
         RowBox[{"t", "=", "1"}], ",", 
         RowBox[{"t", "\[LessEqual]", 
          RowBox[{"Length", "[", "lista", "]"}]}], ",", 
         RowBox[{"t", "++"}], ",", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"coreList", ",", 
           RowBox[{"Map", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"#", " ", "===", " ", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"lista", "[", 
                    RowBox[{"[", "t", "]"}], "]"}], "[", 
                   RowBox[{"[", "1", "]"}], "]"}], "[", 
                  RowBox[{"[", "1", "]"}], "]"}]}], ",", " ", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], " ", "&"}], " ", "/@", 
                   " ", 
                   RowBox[{"lista", "[", 
                    RowBox[{"[", "t", "]"}], "]"}]}], ")"}], "[", 
                 RowBox[{"[", "h", "]"}], "]"}], ",", " ", 
                RowBox[{
                 RowBox[{"templateCore", "[", "templateBase", "]"}], "[", 
                 RowBox[{"[", " ", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"Position", "[", 
                    RowBox[{
                    RowBox[{"BaseTemplateCore", "[", 
                    RowBox[{
                    RowBox[{"k", "[", "template1", "]"}], ",", 
                    RowBox[{"r", "[", "template1", "]"}]}], "]"}], ",", " ", 
                    "#"}], "]"}], "[", 
                    RowBox[{"[", "1", "]"}], "]"}], "[", 
                   RowBox[{"[", "1", "]"}], "]"}], "]"}], "]"}]}], "]"}], " ",
               "&"}], ",", 
             RowBox[{"BaseTemplateCore", "[", 
              RowBox[{
               RowBox[{"k", "[", "template1", "]"}], ",", 
               RowBox[{"r", "[", "template1", "]"}]}], "]"}]}], "]"}]}], 
          "]"}]}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"templateNegado", " ", "=", " ", 
      RowBox[{
       RowBox[{
        RowBox[{"BuildTemplate", "[", 
         RowBox[{
          RowBox[{"k", "[", "template1", "]"}], ",", 
          RowBox[{"r", "[", "template1", "]"}], ",", " ", "#", ",", " ", 
          RowBox[{"Select", "[", 
           RowBox[{
            RowBox[{"DeleteDuplicates", "[", " ", 
             RowBox[{"Flatten", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"postExpansionFn", "[", "template1", "]"}], ",", " ", 
                "FilterReal", ",", " ", "FilterOutOfRange"}], "}"}], "]"}], 
             "]"}], ",", " ", 
            RowBox[{
             RowBox[{"#", " ", "=!=", " ", "IdentityFn"}], " ", "&"}]}], 
           "]"}], ",", " ", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"MemberQ", "[", 
             RowBox[{
              RowBox[{"TemplateCoreVars", "[", "#", "]"}], ",", "w"}], "]"}], 
            ",", " ", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"w", " ", ">", "0"}], ",", " ", 
              RowBox[{"w", " ", "<", " ", 
               RowBox[{"k", "[", "template1", "]"}]}]}], "}"}], ",", " ", 
            RowBox[{"{", "}"}]}], "]"}]}], "]"}], " ", "&"}], " ", "/@", " ", 
       "coreList"}]}], ";", "\[IndentingNewLine]", "templateNegado"}]}], 
   "\[IndentingNewLine]", " ", "]"}]}]], "Input",
 CellChangeTimes->{{3.721836625047767*^9, 3.7218366449968004`*^9}, {
  3.721922922903372*^9, 3.7219229237374926`*^9}, {3.72219614503436*^9, 
  3.7221961471515465`*^9}, {3.727450277359707*^9, 3.7274503121180415`*^9}, {
  3.727451841562174*^9, 3.7274518785723205`*^9}, {3.727452000709155*^9, 
  3.7274520135190988`*^9}, {3.727452052993987*^9, 3.7274520775034447`*^9}, {
  3.727452575692995*^9, 3.727452690518796*^9}, {3.727455677596919*^9, 
  3.727455690058903*^9}, {3.727455747645229*^9, 3.7274557499451675`*^9}, {
  3.7276813953463354`*^9, 3.7276814100066886`*^9}, {3.7276815542293158`*^9, 
  3.7276815576709375`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"FilterReal", "[", 
   RowBox[{"template_Association", ",", "expansion_List"}], "]"}], ":=", " ", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"MissingQ", "[", 
      RowBox[{"SelectFirst", "[", 
       RowBox[{"expansion", ",", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"IntegerPart", "[", "#", "]"}], "\[NotEqual]", " ", "#"}], 
         " ", "&"}]}], "]"}], "]"}], " ", "\[Equal]", " ", "False"}], ",", 
    " ", 
    RowBox[{
     RowBox[{
      RowBox[{"(", "##", ")"}], "&"}], "[", "]"}], ",", "  ", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"IntegerPart", "[", "#", "]"}], "\[Equal]", "#"}], " ", "&&",
          " ", 
         RowBox[{"NumberQ", "[", "#", "]"}]}], ",", 
        RowBox[{"IntegerPart", "[", "#", "]"}], ",", "#"}], "]"}], "&"}], "/@",
      " ", "expansion"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.721906185411691*^9, 3.7219061859848433`*^9}, {
  3.7221158429845195`*^9, 3.7221158433439264`*^9}, {3.7221949684628363`*^9, 
  3.7221949745244985`*^9}, {3.722195281990428*^9, 3.7221952930850325`*^9}, {
  3.722195548809323*^9, 3.7221956005049467`*^9}, {3.722195649226678*^9, 
  3.722195653013464*^9}, {3.722195737073247*^9, 3.7221957434956083`*^9}, {
  3.7221958206478662`*^9, 3.7221958258624887`*^9}, {3.722195861774778*^9, 
  3.722195863179165*^9}, {3.722196488664218*^9, 3.722196495809822*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"ModTemplateQ", "[", "template_Association", "]"}], ":=", 
  RowBox[{"Or", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"postExpansionFn", "[", "template", "]"}], "===", "ModK"}], ",", 
    RowBox[{
     RowBox[{"postExpansionFn", "[", "template", "]"}], "===", 
     "TemplateMod"}], ",", 
    RowBox[{"MemberQ", "[", 
     RowBox[{
      RowBox[{"postExpansionFn", "[", "template", "]"}], ",", "ModK"}], "]"}],
     ",", 
    RowBox[{"MemberQ", "[", 
     RowBox[{
      RowBox[{"postExpansionFn", "[", "template", "]"}], ",", "TemplateMod"}],
      "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.722200413131542*^9, 3.7222004131631155`*^9}}]
},
WindowSize->{958, 988},
WindowMargins->{{-7, Automatic}, {Automatic, 0}},
FrontEndVersion->"11.0 for Microsoft Windows (64-bit) (September 21, 2016)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 124, 2, 30, "Input"],
Cell[685, 24, 2096, 58, 145, "Input"],
Cell[2784, 84, 9760, 199, 392, "Input"],
Cell[12547, 285, 6217, 108, 164, "Input"],
Cell[18767, 395, 8064, 192, 482, "Input"],
Cell[26834, 589, 1471, 35, 69, "Input"],
Cell[28308, 626, 680, 18, 69, "Input"]
}
]
*)

